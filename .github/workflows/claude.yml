name: Claude Code

on:
  # Auto-resolve CodeRabbit review comments
  pull_request_review:
    types: [submitted]

  # Manual @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Job A: Auto-resolve CodeRabbit reviews
  resolve-coderabbit:
    if: >
      github.event_name == 'pull_request_review' &&
      github.event.review.user.login == 'coderabbitai[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    concurrency:
      group: claude-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Analyze review severity
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const reviewId = context.payload.review.id;

            // Fetch all review comments (paginated to handle >100 comments)
            const comments = await github.paginate(github.rest.pulls.listCommentsForReview, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              review_id: reviewId,
              per_page: 100,
            });

            // Count severity levels by parsing CodeRabbit's emoji markers
            // ðŸ”´ Critical, ðŸŸ  Major, ðŸŸ¡ Minor, ðŸŸ¢ Nitpick/Praise
            let critical = 0;
            let major = 0;
            let minor = 0;
            let total = comments.length;

            for (const c of comments) {
              const body = c.body || '';
              if (body.includes('ðŸ”´') || body.includes('| _ðŸ”´ Critical_')) {
                critical++;
              } else if (body.includes('ðŸŸ ') || body.includes('| _ðŸŸ  Major_')) {
                major++;
              } else {
                minor++;
              }
            }

            console.log(`Review has ${total} comments: ${critical} critical, ${major} major, ${minor} minor`);

            // Check iteration count
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const resolveLabels = labels.filter(l => l.name.startsWith('claude-resolve-'));
            const count = resolveLabels.length;
            console.log(`Current iteration count: ${count}`);

            // Decide whether to skip
            let shouldSkip = false;
            let skipReason = '';

            if (count >= 3) {
              shouldSkip = true;
              skipReason = 'iteration_limit';
            } else if (total === 0) {
              shouldSkip = true;
              skipReason = 'no_comments';
            }

            if (shouldSkip) {
              let message = '';
              if (skipReason === 'iteration_limit') {
                message = '## Claude Code: iteration limit reached\n\nI\'ve attempted to resolve CodeRabbit feedback 3 times. A human should review any remaining comments.\n\nTo reset the counter, remove the `claude-resolve-*` labels from this PR.';
              } else if (skipReason === 'no_comments') {
                message = '## Claude Code: CodeRabbit review clean âœ…\n\nNo inline comments found in this review. All issues resolved!';
              }

              if (message) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: message,
                });
              }
            }

            core.setOutput('count', count);
            core.setOutput('should_skip', shouldSkip);
            core.setOutput('critical', critical);
            core.setOutput('major', major);
            core.setOutput('minor', minor);
            core.setOutput('total', total);

      - name: Checkout PR branch
        if: steps.analyze.outputs.should_skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Resolve CodeRabbit comments
        if: steps.analyze.outputs.should_skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            A CodeRabbit review was just submitted on this PR.
            It has ${{ steps.analyze.outputs.critical }} critical, ${{ steps.analyze.outputs.major }} major, and ${{ steps.analyze.outputs.minor }} minor issues.

            Your job: fix EVERY issue CodeRabbit raised â€” critical, major, minor, and nitpicks. All of them.

            ## IMPORTANT: Batch all fixes, single push

            Do NOT push after each individual fix. Make ALL changes first, then commit and push ONCE at the end.
            Each push triggers a CodeRabbit re-review which counts against rate limits. One push = one re-review.

            ## Steps

            1. Read ALL review comments on this PR:
               ```
               gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments --paginate
               gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews/${{ github.event.review.id }}/comments --paginate
               ```

            2. Also read the review body itself for any top-level feedback:
               ```
               gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews/${{ github.event.review.id }}
               ```

            3. Read and understand ALL comments before making any changes.

            4. Fix EVERY issue regardless of severity â€” critical (ðŸ”´), major (ðŸŸ ), minor (ðŸŸ¡), and nitpicks.
               Work through all fixes WITHOUT committing or pushing between them.

            5. After ALL fixes are applied, stage everything and create a SINGLE commit:
               "fix: resolve CodeRabbit review feedback (round $((${{ steps.analyze.outputs.count }} + 1)))"

            6. Push ONCE to the PR branch.

            7. Post a summary comment on the PR listing what you fixed:
               ```
               gh pr comment ${{ github.event.pull_request.number }} --body "## Claude Code: resolved CodeRabbit feedback

               **Round $((${{ steps.analyze.outputs.count }} + 1)) of 3**

               ### Changes made:
               - [list each fix]

               Waiting for CodeRabbit to re-review..."
               ```

      - name: Add iteration label
        if: steps.analyze.outputs.should_skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const count = parseInt('${{ steps.analyze.outputs.count }}') + 1;
            const label = `claude-resolve-${count}`;
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
                color: '6f42c1',
                description: `Claude Code auto-resolve iteration ${count}`,
              });
            } catch (e) {
              // Label already exists, that's fine
            }
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [label],
            });

  # Job B: Interactive @claude mentions
  interactive:
    if: >
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    concurrency:
      group: claude-interactive-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to @claude mention
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
